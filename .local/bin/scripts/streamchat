#!/bin/bash

# Open both video and chat of a livestream on native applications
# GPLv3 - Grim Kriegor <grimkriegor@krutt.org>
# 2020

set -e

clipboard_contents="$(xclip -selection c -o)"
url=${1:-$clipboard_contents}
mode="${2:-best}"

case "${url}" in
  *twitch.tv* )
    platform="Twitch"
    stream_id=$(echo ${url} | sed 's|.*twitch.tv/\(.*\)|\1|g')
    chat_url="${url}/chat"
    chat_software="chatterino"
  ;;
  *youtube.com* )
    platform="YouTube"
    stream_id=$(youtube-dl --get-id "$url")
    chat_url="https://www.youtube.com/live_chat?is_popout=1&v=${stream_id}"
  ;;
  *kick.com* )
    platform="KICK"
    stream_id=$(echo ${url} | sed 's|.*kick.com/\(.*\)|\1|g')
    chat_url="https://kick.com/popout/${stream_id}/chat"
  ;;
  * )
    echo "Unsupported platform."
    exit 1
  ;;
esac

notify-send \
  "${title:-Streaming ${platform} @${stream_id}}" \
  "${message:-$url}"

case "${chat_software}" in
  "chatterino" )
    chatterino -c t:${stream_id} \
      &> /dev/null &
  ;;
  * )
    $BROWSER \
      -P stream \
      --new-window "${chat_url}" \
      &> /dev/null &
      #2>&1 >/dev/null &
  ;;
esac

streamlink \
  --player mpv \
  "${url}" \
  "$mode"
